<?
# THIS IS THE MAIN FILE OF THE PHP WIKIPEDIA SCRIPT

$THESCRIPT = "wiki.phtml" ; # The name of the script. The $PHP_SELF variable doesn't work with Netscape

# Includes the necessary parts
include_once ( "./wikiText.php" ) ;
include_once ( "./basicFunctions.php" ) ;
include_once ( "./databaseFunctions.php" ) ;
include_once ( "./wikiTitle.php" ) ;
include_once ( "./wikiPage.php" ) ;
include_once ( "./wikiUser.php" ) ;

# Checking for talk subpage
function fixTalk ( $title ) {
	$sp = explode ( "/" , $title ) ;
	$ns = explode ( ":" , $title ) ;
	$lsp = array_pop ( $sp ) ;
	if ( strtolower ( $lsp ) == "talk" and count ( $sp ) > 0 ) {
		if ( count ( $ns ) == 1 or strtolower ( $ns[0] ) == "talk" )
			$title = "talk:".implode ( "/" , $sp ) ;
		}
	return $title ;
	}

#EXPERIMENTAL!
function framepage () {
	global $title ;
	$p = "wiki.phtml?" ;
	$v = get_defined_vars() ;
	$vk = array_keys ( $v ) ;
	foreach ( $vk as $x ) {
		$p .= "&$x=".$v[$x] ;
		}

	$ret = "" ;
	$ret .= "<html><head></head><body><FRAMESET rows=\"150,*\"><FRAME src=\"$p&framed=top\">" ;
	$ret .= "<FRAMESET cols=\"*,140\"><FRAME src=\"$p&framed=main\"><FRAME src=\"$p&framed=bar\">" ;
	$ret .= "</FRAMESET></FRAMESET></body></html>" ;

	return $ret ;
	}

# Main program
	global $action , $title , $pageTitle ;
	global $user , $search , $expiration ;
	global $THESCRIPT ;

	global $metaDescription , $metaKeywords ; # For meta tags in the HTML code
	$expiration = time()+315360000 ; # Cookies set will expire in ten years from now
	$pageTitle = "" ;

	# Verifying the current user. Logged in? Password in a cookie?
	$user = new WikiUser ;
	$user->scanCookies () ;

	# Default settings
	if ( $action == "" ) $action = "view" ;
	if ( $title == "" ) $title = $wikiMainPage ;

	$title = fixTalk ( $title ) ;
	$theTitle = new wikiTitle ;
	$theTitle->title = urldecode ( $title ) ;
	$theTitle->makeSecureTitle () ;
	$title = $theTitle->secureTitle ;

	$action = strtolower ( trim ( $action ) ) ;
	$title = urldecode ( $title ) ;

	# Do what is asked
	if ( isset ( $search ) ) {
		include_once ( "./specialPages.php" ) ;
		$out = doSearch () ;
		unset ( $search ) ;
	} else  if ( $action == "watch" ) {
		global $mode ;
		include_once ( "./specialPages.php" ) ;
		$out = watch ( $title , $mode ) ;
	} else if ( $action == "view" ) {
		global $FromEditForm ;
		if ( $user->options["viewFrames"] == "yes" and substr ( $title , 0 , 8 ) != "Special:" and !isset ( $framed ) and !isset ( $FromEditForm ) )
			{ exit ( framepage() ) ; }
		$out = view ( $title ) ;
		}
	else if ( $action == "edit" ) $out = doEdit ( $title ) ;
	else if ( $action == "print" ) $out = doPrint ( $title ) ;
	else if ( $action == "history" ) {
		include_once ( "./specialPages.php" ) ;
		$out = doHistory ( $title ) ;
	} else $out = error ( "No such action \"$action\"" ) ;

	# Cleaning up, setting <title>, etc.
	global $bodyOptions , $headerScript ;
	global $wikiEditTitle ;
	if ( $action == edit ) $pageTitle = str_replace ( "$1" , $title , $wikiEditTitle ) ;
	$pageTitle = str_replace ( "_" , " " , $pageTitle ) ;
	$pageTitle = str_replace ( "$1" , $pageTitle , $wikiTitleTag ) ;
	$bodyOptions .= $user->options["background"] ;
	$bodyOptions .= $user->options["text"] ;
	if ( $metaDescription != "" ) $metaDescription = "<META name=\"description\" content=\"$metaDescription\">" ;
	if ( $metaKeywords != "" ) $metaKeywords = "<META name=\"keywords\" content=\"$metaKeywords\">" ;
	$head = "<HTML><HEAD><TITLE>$pageTitle</TITLE>\n$metaDescription\n$metaKeywords\n$headerScript\n</HEAD><BODY $bodyOptions>\n" ;
	$tail = "</BODY></HTML>" ;

	# Adjusting link style
	$linkStyle = "style=\"color:blue\"" ;
	if ( $user->options["underlineLinks"] == "no" ) $linkStyle = "style=\"color:blue;text-decoration:none\"" ;
	if ( $user->options["forceLinks"] != "" ) $linkStyle = $user->options["forceLinks"] ;
	$out = str_replace ( "<a href=" , "<a $linkStyle href=" , $out ) ;
	$out = str_replace ( "&lt;a style=\"color:blue\"" , "&lt;a " , $out ) ; # Correcting weird replacement above

	global $append , $framed ;
	$out = $head.$out.$tail.$append ;
	if ( isset ( $framed ) ) $out = str_replace ( "<a " , "<a target=_top " , $out ) ;


	print $out ; # FINALLY!!!!
?>