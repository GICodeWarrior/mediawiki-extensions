-- invoke this file with "mysql --user=root --password=[...] < create_and_use_db_analytics.txt"

-- tables implemented:
--   comscore
--   comscore_regions
--   wikistats 
--   page_views     
--   language names 

 
-- more tables needed (O= optional, not needed for report card stage)
--   project_names  
--   binaries       per project, per language, per month, per extension type
-- O edits          per project, per language, per month, per normalization type (Y/N), editor type (manual, anonymous, bot), namespace group (articles, talk pages, other)  
-- O editors        per project, per language, per month, per normalization type (Y/N), editor type (manual, anonymous, bot), namespace group (articles, talk pages, other)  


-- open issues: 
-- only store basic data in database and calculate all aggregates on the fly or do some aggragation before hand ? (e.g. count for mobile / non-mobile / ==> total of both ? <==)
-- for binaries, store one extension type per row? (future proof, more work to query), or a selected few as columns? (one row only needed per month)


-- Create database and two tables from scratch 
DROP DATABASE IF EXISTS `analytics` ;
CREATE DATABASE `analytics` ;

USE `analytics` ;

CREATE TABLE `comscore` (
-- meta data (mostly for auditing, may not be sent over API on default) 
-- not used right now, store meta dat elsewhere,tbd, kept for brainstorm 
--
-- `id`             int auto_increment NOT NULL, 
-- `generated`      timestamp,
-- `source`         char (20),
-- `server`         char (20),
-- `script_name`    char (30),
-- `script_version` char (8),
-- `user`           char (20),
--
-- analytics data  
  `yyyymm`         char (7), 
  `country_code`   char (3), 
  `region_code`    char (2), 
  `property`       char (20), 
  `project`        char (10), 
  `reach`          decimal (4,1) DEFAULT '-1', 
  `visitors`       decimal (15)  DEFAULT '-1', 
  PRIMARY KEY (yyyymm,country_code,region_code,property)
) ;

CREATE TABLE `comscore_regions` (
  `region_code`     char (2), 
  `target_language` char (10),
  `region_name`     char (18),
  PRIMARY KEY (target_language,region_code)
) ;  

CREATE TABLE `wikistats` (
  `yyyymm`                   char (7), 
  `project`                  char (2),
  `language_code`            char (15),
  `editors_all_time`         decimal (10)  DEFAULT '-1', 
  `editors_new`              decimal (7)   DEFAULT '-1', 
  `editors_ge_5`             decimal (7)   DEFAULT '-1', 
  `editors_ge_25`            decimal (7)   DEFAULT '-1', 
  `editors_ge_100`           decimal (7)   DEFAULT '-1', 
  `articles`                 decimal (12)  DEFAULT '-1', 
  `articles_new_per_day`     decimal (9)   DEFAULT '-1', 
  `articles_over_bytes_500`  decimal (12)  DEFAULT '-1', 
  `articles_over_bytes_2000` decimal (12)  DEFAULT '-1', 
  `edits_per_article`        decimal (9,1) DEFAULT '-1', 
  `bytes_per_article`        decimal (9,1) DEFAULT '-1', 
  `edits`                    decimal (12)  DEFAULT '-1', 
  `size_in_bytes`            decimal (15)  DEFAULT '-1', 
  `size_in_words`            decimal (15)  DEFAULT '-1', 
  `links_internal`           decimal (15)  DEFAULT '-1', 
  `links_interwiki`          decimal (15)  DEFAULT '-1', 
  `links_image`              decimal (15)  DEFAULT '-1', 
  `links_external`           decimal (15)  DEFAULT '-1', 
  `redirects`                decimal (15)  DEFAULT '-1', 
  PRIMARY KEY (yyyymm,project,language_code)
) ;

CREATE TABLE `page_views` (
-- analytics data  
  `yyyymm`                      char (7), 
  `project`                     char (2),
  `language_code`               char (15),
  `views_non_mobile_raw`        decimal (15)  DEFAULT '-1', 
  `views_mobile_raw`            decimal (15)  DEFAULT '-1', 
  `views_non_mobile_normalized` decimal (15)  DEFAULT '-1', 
  `views_mobile_normalized`     decimal (15)  DEFAULT '-1', 
  PRIMARY KEY (yyyymm,project,language_code)
) ;

CREATE TABLE `language_names` (
  `target_language`             char (15),   
  `language_code`               char (15),
  `language_name`               char (50),
  PRIMARY KEY (target_language,language_code)
) ;

-- SHOW TABLES ;
-- DESCRIBE comscore ;
-- DESCRIBE comscore_regions ;
-- DESCRIBE wikistats ;
-- DESCRIBE page_views ;
-- DESCRIBE language_names ;

-- Database Manipulation
-- Obviously in real world this is a separate script

-- show contents (debugging only) 
-- SELECT * 
--      FROM comscore_regions ;


LOAD DATA INFILE 'c:/MySQL/analytics/analytics_in_comscore.csv' 
     INTO TABLE comscore 
     FIELDS TERMINATED BY ',' 
     OPTIONALLY ENCLOSED BY '"' 
     (yyyymm,country_code,region_code,property,project,reach,visitors) ;

LOAD DATA INFILE 'c:/MySQL/analytics/analytics_in_comscore_regions.csv' 
     INTO TABLE comscore_regions 
     FIELDS TERMINATED BY ',' 
     OPTIONALLY ENCLOSED BY '"' 
     (target_language,region_code,region_name) ;

LOAD DATA INFILE 'c:/MySQL/analytics/analytics_in_wikistats.csv' 
     INTO TABLE wikistats 
     FIELDS TERMINATED BY ',' 
     OPTIONALLY ENCLOSED BY '"' 
     (project,language_code,yyyymm,editors_all_time,editors_new,editors_ge_5,editors_ge_25,editors_ge_100,articles,articles_new_per_day,articles_over_bytes_500,articles_over_bytes_2000,edits_per_article,bytes_per_article,edits,size_in_bytes,size_in_words,links_internal,links_interwiki,links_image,links_external,redirects) ;

LOAD DATA INFILE 'c:/MySQL/analytics/analytics_in_page_views.csv' 
     INTO TABLE page_views 
     FIELDS TERMINATED BY ',' 
     OPTIONALLY ENCLOSED BY '"' 
     (project,language_code,yyyymm,views_non_mobile_raw,views_mobile_raw,views_non_mobile_normalized,views_mobile_normalized) ;

LOAD DATA INFILE 'c:/MySQL/analytics/analytics_in_language_names.csv' 
     INTO TABLE language_names 
     FIELDS TERMINATED BY ',' 
     OPTIONALLY ENCLOSED BY '"' 
     (target_language,language_code,language_name) ;

-- show contents (debugging only) 
SELECT * 
       FROM comscore 
       ORDER BY yyyymm,country_code,region_code,property,project 
       INTO OUTFILE 'c:/MySQL/analytics/analytics_out_comscore_full_table.csv' 
       FIELDS TERMINATED BY ',' ; 

-- test query (to be described in detail)
-- make sure to delete output file first 
SELECT yyyymm, project, page_views.language_code, language_name, views_non_mobile_normalized, views_mobile_normalized 
       FROM page_views LEFT JOIN language_names 
       ON page_views.language_code = language_names.language_code 
       WHERE (project = 'wp')  AND 
             (yyyymm BETWEEN '2011-03' AND '2011-05') AND 
             (page_views.language_code = 'nl') AND 
             (language_names.target_language = 'en') 
       ORDER BY project,language_name,yyyymm
       INTO OUTFILE 'c:/MySQL/analytics/analytics_out_page_views_test1.csv' 
       FIELDS TERMINATED BY ',' ; 
       
-- expected result:       
-- 2011-03,wp,nl,Dutch,164544225,4994050
-- 2011-04,wp,nl,Dutch,153550168,5427629
-- 2011-05,wp,nl,Dutch,1957423,73106 

-- test query (to be described in detail)
-- make sure to delete output file first 
SELECT yyyymm, project, page_views.language_code, language_name, views_non_mobile_normalized, views_mobile_normalized 
       FROM page_views LEFT JOIN language_names 
       ON page_views.language_code = language_names.language_code 
       WHERE (project = 'wp')  AND 
             (yyyymm BETWEEN '2011-03' AND '2011-05') AND 
             (page_views.language_code = 'nl') AND 
             (language_names.target_language = 'de') 
       ORDER BY project,language_name,yyyymm
       INTO OUTFILE 'c:/MySQL/analytics/analytics_out_page_views_test2.csv' 
       FIELDS TERMINATED BY ',' ; 
       
-- expected result:       
-- 2011-03,wp,nl,Niederländisch,164544225,4994050
-- 2011-04,wp,nl,Niederländisch,153550168,5427629
-- 2011-05,wp,nl,Niederländisch,1957423,73106 

-- export all relevant non-meta data from comsCore's reach by region (and comScore treats India and China as regions in this context)
-- make sure to delete output file first 
SELECT yyyymm,region_name,reach
       FROM comscore LEFT JOIN comscore_regions 
       ON comscore.region_code = comscore_regions.region_code AND comscore_regions.target_language = 'en'
       WHERE (region_name != '') AND (yyyymm BETWEEN '2011-03' AND '2011-05') 
       ORDER BY yyyymm,region_name 
       INTO OUTFILE 'c:/MySQL/analytics/analytics_out_comscore_reach_test1.csv' 
       FIELDS TERMINATED BY ',' ; 
