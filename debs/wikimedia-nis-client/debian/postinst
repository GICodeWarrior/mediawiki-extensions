#! /bin/sh
# postinst script for wikimedia-task-dns-auth
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

case "$1" in
    configure)
	# Add a line to /etc/motd describing the task of this server
	if [ -f /etc/motd.tail ]
	then
		MOTDFILE=/etc/motd.tail
	else
		MOTDFILE=/etc/motd
	fi

	if ! grep -qs "wikimedia-nis-client" $MOTDFILE
	then
		echo "$(hostname) is a Wikimedia NIS client (wikimedia-nis-client)." >> $MOTDFILE

		if [ -f /etc/motd.tail ]
		then
		        # Update motd
	 		uname -snrvm > /var/run/motd
        		cat /etc/motd.tail >> /var/run/motd
		fi
	fi

        echo pmtpa.wmnet >/etc/defaultdomain

        # Update the system to use NIS for users.
        nss-edit passwd "files nis"
        nss-edit group "files nis"
        nss-edit shadow "files nis"

        . /usr/share/debconf/confmodule
        db_version 2.0 || true
        db_set nis/domain pmtpa.wmnet || true
        db_go || true

        /etc/init.d/nis stop

        sed -i 's/^NISCLIENT=.*$/NISCLIENT=true/' /etc/default/nis
        echo 'ypserver nis-1.pmtpa.wmnet
ypserver nis-2.pmtpa.wmnet
ypserver nis-3.pmtpa.wmnet' > /etc/yp.conf

        rm -f /var/yp/bindings/pmtpa.wmnet*

        # Make sure nscd doesn't cache hosts
        sed -i '/enable-cache.*hosts/ { s/yes/no/ }' /etc/nscd.conf
        /etc/init.d/nscd reload
        /etc/init.d/nis start

        # Add the /home mount
        grep -qs '10.0.5.8:/home' /etc/fstab || {
            echo "Adding /home mount..." >&2
            echo >>/etc/fstab \
                '10.0.5.8:/home  /home nfs     bg,soft,udp,rsize=8192,wsize=8192,timeo=14,intr,nfsvers=3  0 0'
            mount /home || true
        }
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


