#! /bin/sh
# postinst script for wikimedia-task-dns-auth
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

checkmount() {
    dev=$1
    mnt=$2

    [ -d $mnt ] || {
        mkdir -p $mnt
        echo "created $mnt" >&2
    }

    grep -qs "^$dev" /etc/fstab || {
        echo "Adding $mnt mount..." >&2
        echo >>/etc/fstab \
            "$dev  $mnt nfs     bg,soft,udp,rsize=8192,wsize=8192,timeo=14,intr,nfsvers=3  0 0"
        mount $mnt || true
    }
}

case "$1" in
    configure)
	# Add a line to /etc/motd describing the task of this server
	if [ -f /etc/motd.tail ]
	then
		MOTDFILE=/etc/motd.tail
	else
		MOTDFILE=/etc/motd
	fi

	if ! grep -qs "wikimedia-task-appserver" $MOTDFILE
	then
		echo "$(hostname) is a Wikimedia application server (wikimedia-task-appserver)." >> $MOTDFILE

		if [ -f /etc/motd.tail ]
		then
		        # Update motd
	 		uname -snrvm > /var/run/motd
        		cat /etc/motd.tail >> /var/run/motd
		fi
	fi

        chown -R pybal-check:pybal-check /var/lib/pybal-check/.ssh

        checkmount amane:/export/upload /mnt/upload3
        checkmount amane:/export/math /mnt/math
		checkmount storage1.wikimedia.org:/export/upload /mnt/upload4

	CLUSTER=$(cat /etc/wikimedia-cluster)
	if [ $CLUSTER="pmtpa" ]
	then
		rsync -a /home/wikipedia/conf/httpd/ /usr/local/apache/conf

		PATH=$PATH:/home/wikipedia/bin
		sync-common
		apache-start
	else
		echo "remember to sync this server before you start it!"
	fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


