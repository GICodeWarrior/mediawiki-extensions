#! /bin/sh /usr/share/dpatch/dpatch-run
## security-CVE-2006-2941.dpatch by  <martin.pitt@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mailman-2.1.8~/Mailman/Handlers/Scrubber.py mailman-2.1.8/Mailman/Handlers/Scrubber.py
--- mailman-2.1.8~/Mailman/Handlers/Scrubber.py	2006-09-12 21:18:03.000000000 +0200
+++ mailman-2.1.8/Mailman/Handlers/Scrubber.py	2006-09-12 21:24:25.000000000 +0200
@@ -209,7 +209,11 @@
                     url = save_attachment(mlist, part, dir)
                 finally:
                     os.umask(omask)
-                filename = part.get_filename(_('not available'))
+                try:
+                    filename = part.get_filename(_('not available'))
+		except (UnicodeDecodeError, ValueError):
+                    # Hack to deal with filename containing ' character.
+                    filename = _('not available')
                 filename = Utils.oneline(filename, lcset)
                 replace_payload_by_text(part, _("""\
 An embedded and charset-unspecified text was scrubbed...
@@ -309,7 +313,7 @@
             desc = part.get('content-description', _('not available'))
             try:
                 filename = part.get_filename(_('not available'))
-            except UnicodeDecodeError:
+            except (UnicodeDecodeError, ValueError):
                 filename = _('not available')
             filename = Utils.oneline(filename, lcset)
             replace_payload_by_text(part, _("""\
