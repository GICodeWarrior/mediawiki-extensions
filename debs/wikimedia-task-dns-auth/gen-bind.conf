#!/usr/bin/python
#
# Generates a bind.conf file from the zonefiles (and symlinks)
# in templates/
# Written on 2005/06/19 by Mark Bergsma <mark@nedworks.org>

import os

bindconfpath = '/etc/powerdns/bind.conf'
templatedir = '/etc/powerdns/templates'

domains = {}

header = '''
# PowerDNS Bind backend configuration file
# Automatically generated by gen-bind.conf

options {
        directory "/etc/powerdns/zones";
};

'''

if __name__ == '__main__':
	for file in os.listdir(templatedir):
		filepath = os.path.join(templatedir, file)

		if not os.path.isfile(filepath): continue
		
		if os.path.islink(filepath) and os.path.exists(filepath):
			domain = os.path.basename(os.path.realpath(filepath))
		else:
			domain = file

		if not domain in domains:
			domains[domain] = [file, ] 
		else:
			domains[domain].append(file)

	# Open output file
	bindconf = open(bindconfpath, 'w')

	# Write header
	bindconf.write(header)

	for domain, aliases in domains.iteritems():
		bindconf.write("# %s aliases\n" % ( domain ))
		for alias in aliases:
			bindconf.write("zone \"%s\"\t{ type master;\tfile \"%s\";\t};\n" % ( alias, alias ))
		bindconf.write('\n')
