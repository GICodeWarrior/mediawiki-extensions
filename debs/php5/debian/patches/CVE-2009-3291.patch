Description: fix certificate spoofing via null-byte certs
upstream, Origin: http://svn.php.net/viewvc?view=revision&revision=288329
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/php5/+bug/446313

diff -Nur php5-5.2.4/ext/openssl/openssl.c php5-5.2.4.new/ext/openssl/openssl.c
--- php5-5.2.4/ext/openssl/openssl.c	2007-08-08 02:29:46.000000000 -0400
+++ php5-5.2.4.new/ext/openssl/openssl.c	2009-11-25 14:41:27.000000000 -0500
@@ -3814,8 +3814,15 @@
 	GET_VER_OPT_STRING("CN_match", cnmatch);
 	if (cnmatch) {
 		int match = 0;
+		int name_len = X509_NAME_get_text_by_NID(name, NID_commonName, buf, sizeof(buf));
 
-		X509_NAME_get_text_by_NID(name, NID_commonName, buf, sizeof(buf));
+		if (name_len == -1) {
+			php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to locate peer certificate CN");
+			return FAILURE;
+		} else if (name_len != strlen(buf)) {
+			php_error_docref(NULL TSRMLS_CC, E_WARNING, "Peer certificate CN=`%.*s' is malformed", name_len, buf);
+			return FAILURE;
+		}
 
 		match = strcmp(cnmatch, buf) == 0;
 		if (!match && strlen(buf) > 3 && buf[0] == '*' && buf[1] == '.') {
@@ -3830,10 +3837,7 @@
 
 		if (!match) {
 			/* didn't match */
-			php_error_docref(NULL TSRMLS_CC, E_WARNING,
-					"Peer certificate CN=`%s' did not match expected CN=`%s'",
-					buf, cnmatch);
-
+			php_error_docref(NULL TSRMLS_CC, E_WARNING, "Peer certificate CN=`%.*s' did not match expected CN=`%s'", name_len, buf, cnmatch);
 			return FAILURE;
 		}
 	}
