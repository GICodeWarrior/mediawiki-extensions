#
# Description: fix denial of service and possible arbitrary code execution
#              via the delimiter argument to the explode function
# Ubuntu: https://bugs.launchpad.net/ubuntu/+source/php5/+bug/286851
# Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=499988
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_operators.h?r1=1.94.2.4.2.11&r2=1.94.2.4.2.12&view=patch
# Patch: http://cvs.php.net/viewvc.cgi/php-src/ext/standard/tests/strings/explode_bug.phpt?hideattic=1&r1=1.1&r2=1.1.2.1
#
diff -Nur php5-5.2.4/ext/standard/tests/strings/explode_bug.phpt php5-5.2.4.new/ext/standard/tests/strings/explode_bug.phpt
--- php5-5.2.4/ext/standard/tests/strings/explode_bug.phpt	1969-12-31 19:00:00.000000000 -0500
+++ php5-5.2.4.new/ext/standard/tests/strings/explode_bug.phpt	2009-01-27 14:13:40.000000000 -0500
@@ -0,0 +1,15 @@
+--TEST--
+Explode/memnstr bug
+--INI--
+error_reporting=2047
+memory_limit=256M
+--FILE--
+<?php
+$res = explode(str_repeat("A",145999999),1);
+var_dump($res);
+?>
+--EXPECTF--
+array(1) {
+  [0]=>
+  string(1) "1"
+}
diff -Nur php5-5.2.4/Zend/zend_operators.h php5-5.2.4.new/Zend/zend_operators.h
--- php5-5.2.4/Zend/zend_operators.h	2007-07-20 20:35:14.000000000 -0400
+++ php5-5.2.4.new/Zend/zend_operators.h	2009-01-27 14:13:40.000000000 -0500
@@ -220,6 +220,9 @@
 	char *p = haystack;
 	char ne = needle[needle_len-1];
 
+	if(needle_len > end-haystack) {
+		return NULL;
+	}
 	end -= needle_len;
 
 	while (p <= end) {
