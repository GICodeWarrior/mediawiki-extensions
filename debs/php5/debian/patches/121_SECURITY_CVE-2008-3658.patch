#
# Description: fix denial of service and possible arbitrary code execution via crafted font file
# Ubuntu: https://bugs.launchpad.net/ubuntu/+source/php5/+bug/286851
# Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=499989
# Patch: http://cvs.php.net/viewvc.cgi/php-src/ext/gd/gd.c?hideattic=1&r1=1.312.2.20.2.35&r2=1.312.2.20.2.36
# Patch: http://cvs.php.net/viewvc.cgi/php-src/ext/gd/tests/imageloadfont_invalid.phpt?hideattic=1&r1=1.1.4.1&r2=1.1.4.2
# Patch: http://cvs.php.net/viewvc.cgi/php-src/ext/gd/tests/imageloadfont_invalid.phpt?hideattic=1&r1=1.1.4.2&r2=1.1.4.3
#
diff -Nur php5-5.2.4/ext/gd/gd.c php5-5.2.4.new/ext/gd/gd.c
--- php5-5.2.4/ext/gd/gd.c	2007-08-29 02:26:30.000000000 -0400
+++ php5-5.2.4.new/ext/gd/gd.c	2009-01-27 14:13:22.000000000 -0500
@@ -1636,6 +1636,22 @@
 		font->nchars = FLIPWORD(font->nchars);
 		body_size = font->w * font->h * font->nchars;
 	}
+		 
+	if (overflow2(font->nchars, font->h)) {
+		php_error_docref(NULL TSRMLS_CC, E_WARNING, "Error reading font, invalid font header");
+		efree(font);
+		php_stream_close(stream);
+		RETURN_FALSE;
+	}
+	if (overflow2(font->nchars * font->h, font->w )) {
+		php_error_docref(NULL TSRMLS_CC, E_WARNING, "Error reading font, invalid font header");
+		efree(font);
+		php_stream_close(stream);
+		RETURN_FALSE;
+	}
+
+
+
 
 	if (body_size != body_size_check) {
 		php_error_docref(NULL TSRMLS_CC, E_WARNING, "Error reading font");
diff -Nur php5-5.2.4/ext/gd/tests/imageloadfont_invalid.phpt php5-5.2.4.new/ext/gd/tests/imageloadfont_invalid.phpt
--- php5-5.2.4/ext/gd/tests/imageloadfont_invalid.phpt	1969-12-31 19:00:00.000000000 -0500
+++ php5-5.2.4.new/ext/gd/tests/imageloadfont_invalid.phpt	2009-01-27 14:13:22.000000000 -0500
@@ -0,0 +1,26 @@
+--TEST--
+imageloadfont() function crashes
+--SKIPIF--
+<?php 
+	if (!extension_loaded('gd')) die("skip gd extension not available\n"); 
+	if (!GD_BUNDLED) die('skip external GD libraries always fail');
+?>
+--FILE--
+<?php
+$filename = dirname(__FILE__) .  '/font.gdf';
+$bin = "\x41\x41\x41\x41\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00";
+$fp = fopen($filename, 'wb');
+fwrite($fp, $bin);
+fclose($fp);
+
+$image = imagecreatetruecolor(50, 20);
+$font = imageloadfont($filename);
+$black = imagecolorallocate($image, 0, 0, 0);
+imagestring($image, $font, 0, 0, "Hello", $black);
+unlink($filename);
+?>
+--EXPECTF--
+Warning: imageloadfont(): gd warning: product of memory allocation multiplication would exceed INT_MAX, failing operation gracefully
+ in %simageloadfont_invalid.php on line %d
+
+Warning: imageloadfont(): Error reading font, invalid font header in %simageloadfont_invalid.php on line %d
