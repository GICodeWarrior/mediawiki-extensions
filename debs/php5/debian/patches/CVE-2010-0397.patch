Description: fix denial of service via xmlrpc crafted argument
Origin: upstream, http://svn.php.net/viewvc?view=revision&revision=296152
Origin: upstream, http://svn.php.net/viewvc?view=revision&revision=296153
Bug: http://bugs.php.net/bug.php?id=51288
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=573573

diff -Nur php5-5.2.4/ext/xmlrpc/tests/bug51288.phpt php5-5.2.4.new/ext/xmlrpc/tests/bug51288.phpt
--- php5-5.2.4/ext/xmlrpc/tests/bug51288.phpt	1969-12-31 19:00:00.000000000 -0500
+++ php5-5.2.4.new/ext/xmlrpc/tests/bug51288.phpt	2010-09-15 08:23:02.000000000 -0400
@@ -0,0 +1,14 @@
+--TEST--
+Bug #51288 (CVE-2010-0397, NULL pointer deref when no <methodName> in request)
+--FILE--
+<?php
+$method = NULL;
+$req = '<?xml version="1.0"?><methodCall></methodCall>';
+var_dump(xmlrpc_decode_request($req, $method));
+var_dump($method);
+echo "Done\n";
+?>
+--EXPECT--
+NULL
+NULL
+Done
diff -Nur php5-5.2.4/ext/xmlrpc/xmlrpc-epi-php.c php5-5.2.4.new/ext/xmlrpc/xmlrpc-epi-php.c
--- php5-5.2.4/ext/xmlrpc/xmlrpc-epi-php.c	2007-01-12 07:32:15.000000000 -0500
+++ php5-5.2.4.new/ext/xmlrpc/xmlrpc-epi-php.c	2010-09-15 08:25:20.000000000 -0400
@@ -708,6 +708,7 @@
    zval* retval = NULL;
    XMLRPC_REQUEST response;
    STRUCT_XMLRPC_REQUEST_INPUT_OPTIONS opts = {{0}};
+   const char *method_name;
    opts.xml_elem_opts.encoding = encoding_in ? utf8_get_encoding_id_from_string(Z_STRVAL_P(encoding_in)) : ENCODING_DEFAULT;
 
    /* generate XMLRPC_REQUEST from raw xml */
@@ -718,10 +719,16 @@
 
       if(XMLRPC_RequestGetRequestType(response) == xmlrpc_request_call) {
          if(method_name_out) {
-            zval_dtor(method_name_out);
-            Z_TYPE_P(method_name_out) = IS_STRING;
-            Z_STRVAL_P(method_name_out) = estrdup(XMLRPC_RequestGetMethodName(response));
-            Z_STRLEN_P(method_name_out) = strlen(Z_STRVAL_P(method_name_out));
+		method_name = XMLRPC_RequestGetMethodName(response);
+		if (method_name) {
+			zval_dtor(method_name_out);
+			Z_TYPE_P(method_name_out) = IS_STRING;
+			Z_STRVAL_P(method_name_out) = estrdup(method_name);
+			Z_STRLEN_P(method_name_out) = strlen(Z_STRVAL_P(method_name_out));
+		} else if (retval) {
+			zval_ptr_dtor(&retval);
+			retval = NULL;
+		}
          }
       }
 
