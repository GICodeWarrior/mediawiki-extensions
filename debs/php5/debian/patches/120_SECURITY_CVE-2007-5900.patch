#
# Description: fix php_admin_value and php_admin_flag restrictions bypass via ini_set
# Ubuntu: https://bugs.launchpad.net/ubuntu/+source/php5/+bug/228095
# Upstream: http://bugs.php.net/bug.php?id=41561
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.c?hideattic=1&r1=1.39.2.2.2.8&r2=1.39.2.2.2.9
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.c?hideattic=1&r1=1.39.2.2.2.9&r2=1.39.2.2.2.10
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.c?hideattic=1&r1=1.39.2.2.2.13&r2=1.39.2.2.2.14
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.c?hideattic=1&r1=1.39.2.2.2.14&r2=1.39.2.2.2.15
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.h?hideattic=1&r1=1.34.2.1.2.4&r2=1.34.2.1.2.5
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.h?hideattic=1&r1=1.34.2.1.2.5&r2=1.34.2.1.2.6
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_vm_def.h?hideattic=1&r1=1.59.2.29.2.47&r2=1.59.2.29.2.48
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_vm_execute.h?hideattic=1&r1=1.62.2.30.2.48&r2=1.62.2.30.2.49
# Patch: http://cvs.php.net/viewvc.cgi/ZendEngine2/zend_ini.c?hideattic=1&r1=1.39.2.2.2.26&r2=1.39.2.2.2.27
#
diff -Nur php5-5.2.4/Zend/zend_ini.c php5-5.2.4.new/Zend/zend_ini.c
--- php5-5.2.4/Zend/zend_ini.c	2007-08-23 14:42:42.000000000 -0400
+++ php5-5.2.4.new/Zend/zend_ini.c	2009-01-27 14:10:46.000000000 -0500
@@ -63,6 +63,9 @@
 		ini_entry->modified = 0;
 		ini_entry->orig_value = NULL;
 		ini_entry->orig_value_length = 0;
+		if (ini_entry->modifiable >= (1 << 3)) {
+			ini_entry->modifiable >>= 3;
+		}
 	}
 	return 0;
 }
@@ -234,8 +237,14 @@
 
 ZEND_API int zend_alter_ini_entry(char *name, uint name_length, char *new_value, uint new_value_length, int modify_type, int stage)
 {
+	return zend_alter_ini_entry_ex(name, name_length, new_value, new_value_length, modify_type, stage, 0);
+}
+
+ZEND_API int zend_alter_ini_entry_ex(char *name, uint name_length, char *new_value, uint new_value_length, int modify_type, int stage, int force_change) /* {{{ */
+{
 	zend_ini_entry *ini_entry;
 	char *duplicate;
+	zend_bool modifiable;
 	zend_bool modified;
 	TSRMLS_FETCH();
 
@@ -243,11 +252,19 @@
 		return FAILURE;
 	}
 
-	if (!(ini_entry->modifiable & modify_type)) {
-		return FAILURE;
+	modifiable = ini_entry->modifiable;
+	modified = ini_entry->modified;
+
+	if (stage == ZEND_INI_STAGE_ACTIVATE && modify_type == ZEND_INI_SYSTEM) {
+		/* only touch lower bits */
+		ini_entry->modifiable = (ini_entry->modifiable & (ZEND_INI_ALL << 3)) | ZEND_INI_SYSTEM;
 	}
 
-	modified = ini_entry->modified;
+	if (!force_change) {
+		if (!(ini_entry->modifiable & modify_type)) {
+			return FAILURE;
+		}
+	}
 
 	if (!EG(modified_ini_directives)) {
 		ALLOC_HASHTABLE(EG(modified_ini_directives));
@@ -256,6 +273,8 @@
 	if (!modified) {
 		ini_entry->orig_value = ini_entry->value;
 		ini_entry->orig_value_length = ini_entry->value_length;
+		/* store orginial value in the upper bits */
+		ini_entry->modifiable = (modifiable << 3) | ini_entry->modifiable;
 		ini_entry->modified = 1;
 		zend_hash_add(EG(modified_ini_directives), name, name_length, &ini_entry, sizeof(zend_ini_entry*), NULL);
 	}
diff -Nur php5-5.2.4/Zend/zend_ini.h php5-5.2.4.new/Zend/zend_ini.h
--- php5-5.2.4/Zend/zend_ini.h	2007-08-02 19:57:21.000000000 -0400
+++ php5-5.2.4.new/Zend/zend_ini.h	2009-01-27 14:10:40.000000000 -0500
@@ -96,6 +96,7 @@
 ZEND_API void zend_unregister_ini_entries(int module_number TSRMLS_DC);
 ZEND_API void zend_ini_refresh_caches(int stage TSRMLS_DC);
 ZEND_API int zend_alter_ini_entry(char *name, uint name_length, char *new_value, uint new_value_length, int modify_type, int stage);
+ZEND_API int zend_alter_ini_entry_ex(char *name, uint name_length, char *new_value, uint new_value_length, int modify_type, int stage, int force_change);
 ZEND_API int zend_restore_ini_entry(char *name, uint name_length, int stage);
 ZEND_API void display_ini_entries(zend_module_entry *module);
 
diff -Nur php5-5.2.4/Zend/zend_vm_def.h php5-5.2.4.new/Zend/zend_vm_def.h
--- php5-5.2.4/Zend/zend_vm_def.h	2007-07-24 15:24:39.000000000 -0400
+++ php5-5.2.4.new/Zend/zend_vm_def.h	2009-01-27 14:10:42.000000000 -0500
@@ -3599,7 +3599,7 @@
 	}
 
 	if (EG(error_reporting)) {
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), "0", 1, ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), "0", 1, ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 	}
 	ZEND_VM_NEXT_OPCODE();
 }
@@ -3619,7 +3619,7 @@
 		Z_TYPE(restored_error_reporting) = IS_LONG;
 		Z_LVAL(restored_error_reporting) = Z_LVAL(EX_T(opline->op1.u.var).tmp_var);
 		convert_to_string(&restored_error_reporting);
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 		zendi_zval_dtor(restored_error_reporting);
 	}
 	if (EX(old_error_reporting) == &EX_T(opline->op1.u.var).tmp_var) {
@@ -3811,7 +3811,7 @@
 		Z_TYPE(restored_error_reporting) = IS_LONG;
 		Z_LVAL(restored_error_reporting) = Z_LVAL_P(EX(old_error_reporting));
 		convert_to_string(&restored_error_reporting);
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 		zendi_zval_dtor(restored_error_reporting);
 	}
 	EX(old_error_reporting) = NULL;
diff -Nur php5-5.2.4/Zend/zend_vm_execute.h php5-5.2.4.new/Zend/zend_vm_execute.h
--- php5-5.2.4/Zend/zend_vm_execute.h	2007-07-24 15:24:39.000000000 -0400
+++ php5-5.2.4.new/Zend/zend_vm_execute.h	2009-01-27 14:10:44.000000000 -0500
@@ -442,7 +442,7 @@
 	}
 
 	if (EG(error_reporting)) {
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), "0", 1, ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), "0", 1, ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 	}
 	ZEND_VM_NEXT_OPCODE();
 }
@@ -592,7 +592,7 @@
 		Z_TYPE(restored_error_reporting) = IS_LONG;
 		Z_LVAL(restored_error_reporting) = Z_LVAL_P(EX(old_error_reporting));
 		convert_to_string(&restored_error_reporting);
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 		zendi_zval_dtor(restored_error_reporting);
 	}
 	EX(old_error_reporting) = NULL;
@@ -4922,7 +4922,7 @@
 		Z_TYPE(restored_error_reporting) = IS_LONG;
 		Z_LVAL(restored_error_reporting) = Z_LVAL(EX_T(opline->op1.u.var).tmp_var);
 		convert_to_string(&restored_error_reporting);
-		zend_alter_ini_entry("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME);
+		zend_alter_ini_entry_ex("error_reporting", sizeof("error_reporting"), Z_STRVAL(restored_error_reporting), Z_STRLEN(restored_error_reporting), ZEND_INI_USER, ZEND_INI_STAGE_RUNTIME, 1);
 		zendi_zval_dtor(restored_error_reporting);
 	}
 	if (EX(old_error_reporting) == &EX_T(opline->op1.u.var).tmp_var) {
