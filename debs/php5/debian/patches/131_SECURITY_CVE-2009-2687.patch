#
# Description: fix denial of service via malformed JPEG image with invalid offset fields
# Patch: http://svn.php.net/viewvc?view=revision&revision=281314
# Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=535888
# Upstream: http://bugs.php.net/bug.php?id=48378
#
diff -Nur php5-5.2.4/ext/exif/exif.c php5-5.2.4.new/ext/exif/exif.c
--- php5-5.2.4/ext/exif/exif.c	2009-08-21 10:44:17.000000000 -0400
+++ php5-5.2.4.new/ext/exif/exif.c	2009-08-21 10:44:27.000000000 -0400
@@ -3210,6 +3210,10 @@
 		exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, "Invalid TIFF start (1)");
 		return;
 	}
+	if (offset_of_ifd > length) {
+		exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, "Invalid IFD start");
+		return;
+	}
 
 	ImageInfo->sections_found |= FOUND_IFD0;
 	/* First directory starts at offset 8. Offsets starts at 0. */
