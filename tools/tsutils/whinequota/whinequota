#! /bin/ksh

fmtsize() {
	sz=$(($1 * 1024))

	kbyte=1024
	mbyte=$((kbyte * 1024))

	if [[ $sz -ge $mbyte ]]; then
		echo $((sz / $mbyte)) MB
	else
		echo $((sz / $kbyte)) KB
	fi
}

fmttime() {
	tm=$1

	hour=$((60 * 60))
	day=$((hour * 24))

	if [[ $tm -ge $day ]]; then
		days=$((tm / day))
		hours=$(((tm % day) / hour))
		if [[ $hours -ge 0 ]]; then
			echo $days days, $hours hours
		else
			echo $days days
		fi
		return;
	fi

	echo $((tm / hour)) hours
}

# for each user
for user in `cut -d: -f1 /etc/passwd`; do
	# uid fs use quota limit grace inodes quota limit grace
	# 0 /home 339412 0 0 0 5269 0 0 0
	quotatool -d -u $user /home | read quid qfs qused qsoft qhard qgrace qinodes qisoft qihard qigrace

	# no quota?
	if [[ $qsoft = 0 ]]; then
		continue
	fi

	# within soft quota?
	if [[ $qused -le $qsoft ]]; then
		continue;
	fi

	msg=\
'From: whinequota <whinequota@hemlock.knams.wikimedia.org>
To: %5$s <%5$s@ts.wikimedia.org>
Subject: You have exceeded your disk quota.
Reply-To: Wikimedia Toolserver Administrators <ts-admins@wikimedia.org>

This message was automatically generated by whinequota on %1$s.

Hello,

'

	# within grace period?
	if [[ $qgrace -ge 0 ]]; then
		msg+=\
'Your disk usage on the system "%1$s" is currently %2$s.  This exceeds your soft quota of %3$s.

Please reduce your usage within %4$s, or you will be unable to create any more files.

If you have any questions, or you would like to request that your quota be increased, please send mail to <ts-admins@wikimedia.org>.
'
	else
		msg+=\
'Your disk usage on the system "%1$s" is currently %2$s.  This exceeds your soft quota of %3$s.  Additionally, you have exceeded your grace period, and are now unable to create new files.

Please reduce your usage.  If you have any questions, or you would like to request that your quota be increased, please send mail to <ts-admins@wikimedia.org>.
'
	fi

	msg+=\
'
Regards,
	whinequota (the program to whine about quotas)
'

	printf "$msg" $(hostname) "$(fmtsize $qused)" "$(fmtsize $qsoft)" "$(fmttime $qgrace)" "$user" \
		| fold -s -w79 \
		| /usr/lib/sendmail -oi -bm -- "$user"
done
