#!/usr/bin/env php
<?php
error_reporting( E_ALL );
/*
 * Returns a space separated list of all active MW versions (e.g. "x.xx").
 * Versions are read from /usr/local/apache/common-local/wikiversions.cdb.
 *
 * Given --home, versions are instead read from /home/wikipedia/common/wikiversions.cdb.
 * Given --withdb, each item in the list will be appended with '=' followed by
 * the DB name of *some* wiki that uses that version. Used to run maintenance scripts.
 *
 * @return string
 */
function getActiveWikiVersions() {
	global $argv;
	$options = array_shift( $argv ); // this file

	if ( in_array( '--home', $options ) ) {
		$path = '/home/wikipedia/common/wikiversions.dat';
	} else {
		$path = '/usr/local/apache/common-local/wikiversions.dat';
	}

	$verList = array_filter( explode( "\n", file_get_contents( $path ) ) );
	if ( !count( $verList ) ) {
		die( "Unable to read wikiversions.dat.\n" );
	}

	$result = $activeVersions = array();
	foreach ( $verList as $item ) {
		list( $dbname, $version ) = explode( ' ', $item );
		$version = str_replace( 'php-', '', $version ); // remove 'php-'
		if ( !isset( $activeVersions[$version] ) ) {
			$activeVersions[$version] = 1;
			if ( in_array( '--withdb', $options ) ) {
				$result[] = "{$version}={$dbname}";
			} else {
				$result[] = "{$version}";
			}
		}
	}

	return implode( ' ', $result );
}

echo getActiveWikiVersions();
