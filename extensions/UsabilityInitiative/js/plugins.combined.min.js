
(function($){$.whileAsync=function(opts)
{var delay=Math.abs(opts.delay)||10,bulk=isNaN(opts.bulk)?500:Math.abs(opts.bulk),test=opts.test||function(){return true;},loop=opts.loop||function(){},end=opts.end||function(){};(function(){var t=false,begin=new Date();while(t=test())
{loop();if(bulk===0||(new Date()-begin)>bulk)
{break;}}
if(t)
{setTimeout(arguments.callee,delay);}
else
{end();}})();}
$.eachAsync=function(array,opts)
{var i=0,l=array.length,loop=opts.loop||function(){};$.whileAsync($.extend(opts,{test:function(){return i<l;},loop:function()
{var val=array[i];return loop.call(val,i++,val);}}));}
$.fn.eachAsync=function(opts)
{$.eachAsync(this,opts);return this;}})(jQuery);(function($){$.browserTest=function(a,z){var u='unknown',x='X',m=function(r,h){for(var i=0;i<h.length;i=i+1){r=r.replace(h[i][0],h[i][1]);}
return r;},c=function(i,a,b,c){var r={name:m((a.exec(i)||[u,u])[1],b)};r[r.name]=true;r.version=(c.exec(i)||[x,x,x,x])[3];if(r.name.match(/safari/)&&r.version>400){r.version='2.0';}
if(r.name==='presto'){r.version=($.browser.version>9.27)?'futhark':'linear_b';}
r.versionNumber=parseFloat(r.version,10)||0;r.versionX=(r.version!==x)?(r.version+'').substr(0,1):x;r.className=r.name+r.versionX;return r;};a=(a.match(/Opera|Navigator|Minefield|KHTML|Chrome/)?m(a,[[/(Firefox|MSIE|KHTML,\slike\sGecko|Konqueror)/,''],['Chrome Safari','Chrome'],['KHTML','Konqueror'],['Minefield','Firefox'],['Navigator','Netscape']]):a).toLowerCase();$.browser=$.extend((!z)?$.browser:{},c(a,/(camino|chrome|firefox|netscape|konqueror|lynx|msie|opera|safari)/,[],/(camino|chrome|firefox|netscape|netscape6|opera|version|konqueror|lynx|msie|safari)(\/|\s)([a-z0-9\.\+]*?)(\;|dev|rel|\s|$)/));$.layout=c(a,/(gecko|konqueror|msie|opera|webkit)/,[['konqueror','khtml'],['msie','trident'],['opera','presto']],/(applewebkit|rv|konqueror|msie)(\:|\/|\s)([a-z0-9\.]*?)(\;|\)|\s)/);$.os={name:(/(win|mac|linux|sunos|solaris|iphone)/.exec(navigator.platform.toLowerCase())||[u])[0].replace('sunos','solaris')};if(!z){$('html').addClass([$.os.name,$.browser.name,$.browser.className,$.layout.name,$.layout.className].join(' '));}};$.browserTest(navigator.userAgent);})(jQuery);jQuery.cookie=function(name,value,options){if(typeof value!='undefined'){options=options||{};if(value===null){value='';options.expires=-1;}
var expires='';if(options.expires&&(typeof options.expires=='number'||options.expires.toUTCString)){var date;if(typeof options.expires=='number'){date=new Date();date.setTime(date.getTime()+(options.expires*24*60*60*1000));}else{date=options.expires;}
expires='; expires='+date.toUTCString();}
var path=options.path?'; path='+(options.path):'';var domain=options.domain?'; domain='+(options.domain):'';var secure=options.secure?'; secure':'';document.cookie=[name,'=',encodeURIComponent(value),expires,path,domain,secure].join('');}else{var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}};(function($){$.fn.extend({encapsulateSelection:function(pre,peri,post){function checkSelectedText(){if(!selText){selText=peri;isSample=true;}else if(selText.charAt(selText.length-1)==' '){selText=selText.substring(0,selText.length-1);post+=' '}}
var e=this.jquery?this[0]:this;var selText;var isSample=false;if(document.selection&&document.selection.createRange){if(document.documentElement&&document.documentElement.scrollTop){var winScroll=document.documentElement.scrollTop;}else if(document.body){var winScroll=document.body.scrollTop;}
e.focus();var range=document.selection.createRange();selText=range.text;checkSelectedText();range.text=pre+selText+post;if(isSample&&range.moveStart){if(window.opera){post=post.replace(/\n/g,'');}
range.moveStart('character',-post.length-selText.length);range.moveEnd('character',-post.length);}
range.select();if(document.documentElement&&document.documentElement.scrollTop){document.documentElement.scrollTop=winScroll}else if(document.body){document.body.scrollTop=winScroll;}}else if(e.selectionStart||e.selectionStart=='0'){var textScroll=e.scrollTop;e.focus();var startPos=e.selectionStart;var endPos=e.selectionEnd;selText=e.value.substring(startPos,endPos);checkSelectedText();e.value=e.value.substring(0,startPos)+pre+selText+post+
e.value.substring(endPos,e.value.length);if(isSample){e.selectionStart=startPos+pre.length;e.selectionEnd=startPos+pre.length+selText.length;}else{e.selectionStart=startPos+pre.length+selText.length+post.length;e.selectionEnd=e.selectionStart;}
e.scrollTop=textScroll;}
$(this).trigger('encapsulateSelection');},getCaretPosition:function(){function getCaret(e){var caretPos=0;if($.browser.msie){var postFinished=false;var periFinished=false;var postFinished=false;var preText,rawPreText,periText;var rawPeriText,postText,rawPostText;var periRange=document.selection.createRange().duplicate();var preRange=document.body.createTextRange();preRange.moveToElementText(e);preRange.setEndPoint("EndToStart",periRange);var postRange=document.body.createTextRange();postRange.moveToElementText(e);postRange.setEndPoint("StartToEnd",periRange);preText=rawPreText=preRange.text;periText=rawPeriText=periRange.text;postText=rawPostText=postRange.text;do{if(!postFinished){if(preRange.compareEndPoints("StartToEnd",preRange)==0){postFinished=true;}else{preRange.moveEnd("character",-1)
if(preRange.text==preText){rawPreText+="\r\n";}else{postFinished=true;}}}
if(!periFinished){if(periRange.compareEndPoints("StartToEnd",periRange)==0){periFinished=true;}else{periRange.moveEnd("character",-1)
if(periRange.text==periText){rawPeriText+="\r\n";}else{periFinished=true;}}}
if(!postFinished){if(postRange.compareEndPoints("StartToEnd",postRange)==0){postFinished=true;}else{postRange.moveEnd("character",-1)
if(postRange.text==postText){rawPostText+="\r\n";}else{postFinished=true;}}}}while((!postFinished||!periFinished||!postFinished));caretPos=rawPreText.replace(/\r\n/g,"\n").length;}else if(e.selectionStart||e.selectionStart=='0'){caretPos=e.selectionStart;}
return caretPos;}
return getCaret(this.get(0));},scrollToCaretPosition:function(pos){function getLineLength(e){return Math.floor(e.scrollWidth/($.os.name=='linux'?7:8));}
function getCaretScrollPosition(e){var text=e.value.replace(/\r/g,"");var caret=$(e).getCaretPosition();var lineLength=getLineLength(e);var row=0;var charInLine=0;var lastSpaceInLine=0;for(i=0;i<caret;i++){charInLine++;if(text.charAt(i)==" "){lastSpaceInLine=charInLine;}else if(text.charAt(i)=="\n"){lastSpaceInLine=0;charInLine=0;row++;}
if(charInLine>lineLength){if(lastSpaceInLine>0){charInLine=charInLine-lastSpaceInLine;lastSpaceInLine=0;row++;}}}
var nextSpace=0;for(j=caret;j<caret+lineLength;j++){if(text.charAt(j)==" "||text.charAt(j)=="\n"||caret==text.length){nextSpace=j;break;}}
if(nextSpace>lineLength&&caret<=lineLength){charInLine=caret-lastSpaceInLine;row++;}
return($.os.name=='mac'?13:($.os.name=='linux'?15:16))*row;}
return this.each(function(){$(this).focus();if(this.selectionStart||this.selectionStart=='0'){this.selectionStart=pos;this.selectionEnd=pos;$(this).scrollTop(getCaretScrollPosition(this));}else if(document.selection&&document.selection.createRange){range=document.selection.createRange();oldPos=$(this).bytePos();goBack=false;if(oldPos==pos){pos++;goBack=true;}
range.moveToElementText(this);range.collapse();range.move('character',pos);range.select();this.scrollTop+=range.offsetTop;if(goBack){range.move('character',-1);range.select();}}
$(this).trigger('scrollToPosition');});}});})(jQuery);(function($){$.wikiEditor={'modules':{}};$.fn.wikiEditor=function(){var context=$(this).data('context');if(typeof context!=='undefined'){arguments=$.makeArray(arguments);if(arguments.length>0){var call=arguments.shift();if(call in context.api){context.api[call](arguments);}
return $(this).data('context',context);}
return $(this);}
context={'$textarea':$(this),'modules':{},'data':{}};$(this).wrap($('<div></div>').addClass('wikiEditor-ui')).wrap($('<div></div>').addClass('wikiEditor-ui-bottom')).wrap($('<div></div>').addClass('wikiEditor-ui-text'));context.$ui=$(this).parent().parent().parent();context.$ui.prepend($('<div></div>').addClass('wikiEditor-ui-top'));context.api={addModule:function(){if(arguments.length>=1&&arguments[0].length>=1){var module=arguments[0][0];var configuration=(arguments[0][1]?arguments[0][1]:{});if(module in $.wikiEditor.modules&&'create'in $.wikiEditor.modules[module]){$.wikiEditor.modules[module].create(context,configuration);}}}};context.$textarea.scrollToCaretPosition(0);if(arguments.length>0&&typeof arguments[0]=='object'){if('modules'in arguments[0]){for(module in arguments[0].modules){context.api.addModule([module,arguments[0].modules[module]]);}}}
return $(this).data('context',context);;};})(jQuery);(function($){$.wikiEditor.modules.toc={create:function(context,configuration){if('$toc'in context.modules){return;}
context.modules.$toc=$('<div></div>').addClass('wikiEditor-ui-toc');$.wikiEditor.modules.toc.build(context,configuration);context.$ui.find('.wikiEditor-ui-bottom').append(context.modules.$toc);context.modules.$toc.height(context.$ui.find('.wikiEditor-ui-bottom').height());context.modules.$toc.css('width','12em');context.$ui.find('.wikiEditor-ui-text').css('marginRight','12em');$.wikiEditor.modules.toc.build(context);$.wikiEditor.modules.toc.update(context);context.$textarea.bind('keyup encapsulateSelection',function(event){var context=$(this).data('context');$(this).eachAsync({bulk:0,loop:function(){$.wikiEditor.modules.toc.build(context);$.wikiEditor.modules.toc.update(context);}});}).bind('mouseup scrollToPosition',function(event){var context=$(this).data('context');$(this).eachAsync({bulk:0,loop:function(){$.wikiEditor.modules.toc.update(context);}});});},update:function(context){context.modules.$toc.find('a').removeClass('currentSelection');var position=context.$textarea.getCaretPosition();var section=0;if(context.data.outline.length>0){if(!(position<context.data.outline[0].position-1)){while(section<context.data.outline.length&&context.data.outline[section].position-1<position){section++;}
section=Math.max(0,section);}
context.modules.$toc.find('a.section-'+section).addClass('currentSelection');}},build:function(context,configuration,editorId){function buildStructure(outline,offset,level){if(offset==undefined)offset=0;if(level==undefined)level=1;var sections=[];for(var i=offset;i<outline.length;i++){if(outline[i].nLevel==level){var sub=buildStructure(outline,i+1,level+1);if(sub.length){outline[i].sections=sub;}
sections[sections.length]=outline[i];}else if(outline[i].nLevel<level){break;}}
return sections;}
function buildList(structure){var list=$('<ul></ul>');for(i in structure){var item=$('<li></li>').append($('<a></a>').attr('href','#').addClass('section-'+structure[i].index).data('textbox',context.$textarea).data('position',structure[i].position).click(function(event){$(this).data('textbox').scrollToCaretPosition($(this).data('position'));event.preventDefault();}).text(structure[i].text));if(structure[i].sections!==undefined){item.append(buildList(structure[i].sections));}
list.append(item);}
return list;}
var outline=[];var wikitext='\n'+context.$textarea.val()+'\n';var headings=wikitext.match(/\n={1,5}.*={1,5}(?=\n)/g);var offset=0;for(var h=0;h<headings.length;h++){text=headings[h];var position=wikitext.indexOf(text,offset);if(position>offset){offset=position;}else if(position==-1){continue;}
text=$.trim(text);var startLevel=0;for(var c=0;c<text.length;c++){if(text.charAt(c)=='='){startLevel++;}else{break;}}
var endLevel=0;for(var c=text.length-1;c>=0;c--){if(text.charAt(c)=='='){endLevel++;}else{break;}}
var level=Math.min(startLevel,endLevel);text=$.trim(text.substr(level,text.length-(level*2)));outline[h]={'text':text,'position':position,'level':level,'index':h+1};}
var lastLevel=0;var nLevel=0;for(var i=0;i<outline.length;i++){if(outline[i].level>lastLevel){nLevel++;}
else if(outline[i].level<lastLevel){nLevel-=Math.max(1,lastLevel-outline[i].level);}
outline[i].nLevel=nLevel;lastLevel=nLevel;}
var structure=buildStructure(outline);structure.unshift({'text':wgTitle,'level':1,'index':0,'position':0});context.modules.$toc.html(buildList(structure));context.data.outline=outline;}};})(jQuery);(function($){$.wikiEditor.modules.toolbar={imgPath:wgScriptPath+'/extensions/UsabilityInitiative/images/wikiEditor/toolbar',create:function(context,configuration){if('$toolbar'in context.modules){return;}
context.modules.$toolbar=$('<div></div>').addClass('wikiEditor-ui-toolbar');$.wikiEditor.modules.toolbar.build(context,configuration);context.$ui.find('.wikiEditor-ui-top').append(context.modules.$toolbar);},performAction:function(context,action){switch(action.type){case'encapsulate':var parts={'pre':'','peri':'','post':''};for(part in parts){if(part+'Msg'in action.options){parts[part]=gM(action.options[part+'Msg'],(action.options[part]||null));}else{parts[part]=(action.options[part]||'')}}
context.$textarea.encapsulateSelection(parts.pre,parts.peri,parts.post);break;default:break;}},addSection:function(context,$section,section,sectionId){var useTool=function(){var tool=$(this).data('tool');if('type'in tool){switch(tool.type){case'button':case'link':if('action'in tool){$.wikiEditor.modules.toolbar.performAction(context,tool.action);}
break;case'select':if('list'in tool&&$(this).val()in tool.list){$.wikiEditor.modules.toolbar.performAction(context,tool.list[$(this).val()].action);}
$(this).find(":selected").attr('selected',false);$(this).find(":first").attr('selected',true);break;}}
return false;}
function addTools($group,tools,sectionId){for(tool in section.groups[group].tools){if('filters'in tools[tool]){var skip=false;for(filter in tools[tool].filters){if($(tools[tool].filters[filter]).size()==0){skip=true;}}
if(skip){continue;}}
var label=msg(tools[tool],'label');switch(tools[tool].type){case'button':$group.append($('<input />').attr({'src':$.wikiEditor.modules.toolbar.imgPath+
tools[tool].icon,'alt':label,'title':label,'type':'image'}).addClass('tool').addClass('tool-'+tool).data('tool',tools[tool]).click(useTool));break;case'select':var $select=$('<select></select>').data('tool',tools[tool]).change(useTool).append($('<option></option>').text(label)).appendTo($group);for(option in tools[tool].list){$select.append($('<option></option>').text(msg(tools[tool].list[option],'label')).attr('value',option));}
break;}}}
function addPages($index,$pages,pages,sectionId){var selected=$.cookie(sectionId);if(!(selected in pages)){selected=null;}
for(page in pages){if(!('layout'in pages[page])){continue;}
if(selected==null){selected=page;}
$index.append($('<div></div>').attr('class',page===selected?'current':null).text(msg(pages[page],'label')).data('page',page).data('sectionId',sectionId).click(function(){$(this).parent().parent().find('.page').hide().end().parent().find('div').removeClass('current').end().parent().parent().find('.page-'+$(this).data('page')).show();$(this).addClass('current');$.cookie($(this).data('sectionId'),$(this).data('page'));}));var $page=$('<div></div>').addClass('page').addClass('page-'+page).css('display',page==selected?'block':'none').appendTo($pages);switch(pages[page].layout){case'table':var $table=$('<table></table>').attr({'cellpadding':'0','cellspacing':'0','border':'0','width':'100%'}).appendTo($page);if('headings'in pages[page]&&typeof pages[page].headings=='object'){var $headings=$('<tr></tr>').appendTo($table);for(heading in pages[page].headings){var content=msg(pages[page].headings[heading],'content');$('<th></th>').text(content).appendTo($headings);}}
if('rows'in pages[page]&&typeof pages[page].rows=='object'){for(row in pages[page].rows){var $row=$('<tr></tr>').appendTo($table);for(cell in pages[page].rows[row]){var content=msg(pages[page].rows[row][cell],'content');$('<td></td>').addClass(cell).attr('valign','top').append($('<span></span>').html(content)).appendTo($row);}}}
break;case'characters':var $characters=$('<div></div>').attr(pages[page].attributes).css(pages[page].styles).appendTo($page);if('characters'in pages[page]&&typeof pages[page].characters=='object'){for(character in pages[page].characters){var char=pages[page].characters[character];var tool={};if(typeof char=='string'){tool={'type':'link','label':char,'action':{'type':'encapsulate','options':{'pre':char}}};}else if(typeof char=='object'){tool=char;}else{continue;}
if(!('label'in tool)){continue;}
$characters.append($('<a></a>').attr('href','#').text(tool.label).data('tool',tool).click(useTool));}}
break;}}}
function msg(object,property){return object[property]||gM(object[property+'Msg']);}
function objHasMsg(object,property){return property in object||property+'Msg'in object;}
switch(section.type){case'toolbar':if(!('groups'in section)){return;}
for(group in section.groups){var $group=$('<div></div>').attr('class','group').appendTo($section);if(objHasMsg(section.groups[group],'label')){$group.append($('<div></div>').attr('class','label').text(msg(section.groups[group],'label')))}
addTools($group,section.groups[group].tools,sectionId);}
break;case'booklet':if(!('pages'in section)){return;}
var $index=$('<div></div>').attr('class','index').appendTo($section);var $pages=$('<div></div>').attr('class','pages').appendTo($section);addPages($index,$pages,section.pages,sectionId);break;}},build:function(context,configuration,editorId){if('main'in configuration){$.wikiEditor.modules.toolbar.addSection(context,context.modules.$toolbar,configuration.main,'main');}
var sectionIdBase=editorId+'-wikiEditor-ui-toolbar-section';var $tabs=$('<div></div>').addClass('tabs').appendTo(context.modules.$toolbar);var $sections=$('<div></div>').addClass('sections').appendTo(context.modules.$toolbar);context.modules.$toolbar.append($('<div></div>').addClass('break'));var sectionQueue=[];for(section in configuration){if(section=='main'){continue;}
var sectionCookie=editorId+'-section';var sectionId=sectionCookie+'-'+section.type+'-'+section;var $section=$('<div></div>').addClass('section loading').addClass('section-'+configuration[section].type).addClass('section-'+configuration[section].type+'-'+section).attr('id',sectionId).append($('<div></div>').addClass('spinner').text(gM('edittoolbar-loading'))).appendTo($sections);var current=false;if($.cookie(sectionCookie)==sectionId){$section.attr('style','display:block');current=true;}
sectionQueue[sectionQueue.length]={'$section':$section,'tools':configuration[section],'id':sectionId};$tabs.append($('<span></span>').attr('class','tab').append($('<a></a>').text(configuration[section].label||gM(configuration[section].labelMsg)).attr({'href':'#','rel':section}).addClass(current?'current':null).data('$section',$section).data('sectionCookie',sectionCookie).click(function(){var $section=$(this).data('$section');$(this).blur();var show=$section.css('display')=='none';$section.parent().children().hide();$(this).parent().parent().find('a').removeClass('current');if(show){$section.show();$(this).addClass('current');}
$.cookie($(this).data('sectionCookie'),show?$section.attr('id'):null);return false;})));}
$.eachAsync(sectionQueue,{bulk:0,loop:function(index,section){$.wikiEditor.modules.toolbar.addSection(context,section.$section,section.tools,section.id);section.$section.removeClass('loading')}});}};})(jQuery);